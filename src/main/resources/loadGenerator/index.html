<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Site Administration</title>

  <link rel="stylesheet" type="text/css" href="loadGenerator.css">

</head>
<body>
  <div id="header">
  </div>

  <div id="content">
    <h2>Site administration <span id="clusterSiteInfo"> </span> </h2>
    <div class="loadGenerator">
    	<dl class="loadUrl">
    		<dt>Url:</dt>
    		<dd><input type="text" /></dd>
    	</dl>
		<input type="text" class="sliderValue" value="" readonly="readonly" />
		<div class="js_slider slider" data-min="100"
		                              data-max="0"
		                              data-start=""
		                              data-step="-1"
		                              data-units=" slower, faster" >
		    <span class="leftBar"></span>
		    <img class="handle" src="/img/slider.png" width="42" height="24" style="left:75px;" />
		    <span class="min">slower</span>
		    <span class="max">faster</span>
		</div>
  </div>

  <div style="position: absolute; display: none;" id="tooltip"></div>

    <script type="application/javascript" src="/underscore.min.js"></script>
    <script type="application/javascript" src="/jquery.min.js"></script>
    <script type="application/javascript" src="/slider.js"></script>
    <script type="application/javascript">
    	var data = {}
    	
			
	   	$.get("/loadGenerator/get", function(model) {
	   		var data = model
		   	var $loadGenerator = $(".loadGenerator")
		   	var $statistics = $("<div></div>").addClass("statistics");
		   	$loadGenerator.append($statistics)
		   	var renderStatistics = function(statictics) {
		   		if (!statictics) { return ; }
	   			$statistics.empty();
    			var $table = $("<table></table>");
    			var $header = $("<tr></tr>")
    			$header.append("<th>RetCode</th>")
    			$header.append("<th>Count</th>")
    			$header.append("<th>Bytes</th>")
    			$header.append("<th>mSec</th>")
    			var $thead = $("<thead></thead>")
    			$thead.append($header);
    			$table.append($thead);
    			var $tbody = $("<tbody></tbody>");
    			for(var retCode in statictics.requests) {
    				var request = statictics.requests[retCode]
    				var $row = $("<tr></tr>")
    				$row.append($("<td></td>").html(retCode));
    				$row.append($("<td></td>").html(request.count));
    				$row.append($("<td></td>").html(request.bytes));
    				$row.append($("<td></td>").html(request.msecs));
     				$tbody.append($row)
    			}
    			$table.append($tbody);
    			var $tfoot = $("<tfoot></tfoot>")
    			$tfoot.append($header.clone());
    			$table.append($tfoot)
    			$statistics.append($table);
    		}
 console.log(data, $loadGenerator);
		   	renderStatistics(data.statictics);

			var $urlText = $loadGenerator.find("dl dd input")
			$urlText.val(data.url);
			var $sliders = $loadGenerator.find(".js_slider")
			$loadGenerator.fadeIn("fast", function() {
		    	var $text = $loadGenerator.find('.sliderValue')
		    	var postActive = false
		    	var storeValue = _.debounce(function() {
		    		data.value = $text.val();
		    		data.url = $urlText.val();
					postActive = true;
		    		$.ajax({
		    			type: "POST",
		    			url: "/loadGenerator/put", 
		    			data: data, 
		    			success: function() { postActive = false }
		    		});
		    	}, 500);
		    	$urlText.bind("change", storeValue);    	
		    	$sliders.each(function() {
		    		var $slider = $(this)
		    		$slider.attr("data-start", data.value);
			    	var $left_bar = $slider.find(".leftBar");
			    	var slider = new Slider()
			    	$slider.data("slider", slider)
					slider.bind("change", function(value, width) {
//console.log("change", value);
					  $left_bar.css("width", width+5+"px");
					  $text.val(value)
					  $text.html(value)
					  storeValue();
					}).bind('init', function() {
					  //$slider.find(".min").html(~~$slider.attr("data-min")+ "%")
					  //$slider.find(".max").html(~~$slider.attr("data-max")+ "%")
					}).init($slider)
				})
//console.log("-1-");
				var updater = function() {
//					console.log("refresh");
					$.get("/loadGenerator/get", function(model) {
						data = model;
						$sliders.each(function() {
							$(this).data("slider").setValue(data.value);
						})
						renderStatistics(data.statictics);
						setTimeout(updater, 15000);
					})
				}
//console.log("-2-");
	   			setTimeout(updater, 15000);
	   		})
		})
    </script>

</body>
</html>
